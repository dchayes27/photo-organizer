<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .photo-card {
            transition: all 0.2s ease;
        }
        .photo-card:hover {
            transform: translateY(-4px);
        }
        .dark .photo-card:hover {
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .photo-card:hover {
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
        }
        .thumbnail {
            aspect-ratio: 1;
            object-fit: cover;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 min-h-screen transition-colors">
    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-semibold text-slate-900 dark:text-white">
                        Photos
                    </h1>
                    <button id="stats-toggle" class="text-xs font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 transition-colors flex items-center gap-1">
                        <span id="stats-summary">1,636 photos • 560 GB</span>
                        <svg id="stats-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                <button id="theme-toggle" class="p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-sm">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5 text-slate-700" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5 text-slate-200" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Stats (Collapsible) -->
        <div id="stats-panel" class="hidden mb-8 overflow-hidden">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                <div class="bg-white dark:bg-slate-800 rounded-lg p-4 border border-slate-200 dark:border-slate-700">
                    <div class="text-slate-500 dark:text-slate-400 mb-1">Photos</div>
                    <div id="total-photos" class="text-xl font-semibold text-slate-900 dark:text-white">Loading...</div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-lg p-4 border border-slate-200 dark:border-slate-700">
                    <div class="text-slate-500 dark:text-slate-400 mb-1">Size</div>
                    <div id="total-size" class="text-xl font-semibold text-slate-900 dark:text-white">...</div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-lg p-4 border border-slate-200 dark:border-slate-700">
                    <div class="text-slate-500 dark:text-slate-400 mb-1">Duplicates</div>
                    <div id="duplicate-groups" class="text-xl font-semibold text-slate-900 dark:text-white">...</div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-lg p-4 border border-slate-200 dark:border-slate-700">
                    <div class="text-slate-500 dark:text-slate-400 mb-1">Formats</div>
                    <div id="formats" class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">...</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="glass-card rounded-2xl shadow-lg p-6 mb-10">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Search</label>
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search by path..."
                        class="w-full px-4 py-3 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-all text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500"
                    >
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Category</label>
                    <select
                        id="category-select"
                        class="w-full px-4 py-3 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-all text-slate-900 dark:text-slate-100"
                    >
                        <option value="">All Categories</option>
                        <option value="screenshot">Screenshots</option>
                        <option value="photo">Photos</option>
                        <option value="wallpaper">Wallpapers</option>
                        <option value="social">Social</option>
                        <option value="icon">Icons</option>
                        <option value="graphic">Graphics</option>
                        <option value="image">Images</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Sort By</label>
                    <select
                        id="sort-select"
                        class="w-full px-4 py-3 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-all text-slate-900 dark:text-slate-100"
                    >
                        <option value="date_modified">Date Modified</option>
                        <option value="date_taken">Date Taken</option>
                        <option value="file_size">File Size</option>
                        <option value="width">Width</option>
                        <option value="height">Height</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">View</label>
                    <button
                        id="duplicates-btn"
                        class="w-full px-4 py-3 bg-gradient-to-r from-rose-500 to-pink-500 text-white font-semibold rounded-xl hover:from-rose-600 hover:to-pink-600 transition-all shadow-lg shadow-rose-500/30"
                    >
                        Show Duplicates
                    </button>
                </div>
            </div>
        </div>

        <!-- Photos Grid -->
        <div id="photos-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
            <!-- Photos will be loaded here -->
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-slate-200 dark:border-slate-700 border-t-violet-600 dark:border-t-violet-400"></div>
            <p class="mt-4 text-slate-600 dark:text-slate-400 font-medium">Loading photos...</p>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="mt-10 flex justify-center items-center gap-4 hidden">
            <button id="prev-btn" class="px-6 py-3 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-violet-700 hover:to-indigo-700 disabled:from-slate-300 disabled:to-slate-400 disabled:cursor-not-allowed transition-all shadow-lg shadow-violet-500/30">
                Previous
            </button>
            <span id="page-info" class="px-6 py-3 text-slate-700 dark:text-slate-200 font-semibold bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-100 dark:border-slate-700"></span>
            <button id="next-btn" class="px-6 py-3 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-violet-700 hover:to-indigo-700 disabled:from-slate-300 disabled:to-slate-400 disabled:cursor-not-allowed transition-all shadow-lg shadow-violet-500/30">
                Next
            </button>
        </div>
    </div>

    <!-- Edit Photo Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Edit Photo</h2>
                <button id="close-modal" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                    <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Image Preview -->
                    <div>
                        <img id="modal-image" src="" alt="" class="w-full rounded-xl border border-slate-200 dark:border-slate-700">
                    </div>

                    <!-- Edit Form -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">File Name</label>
                            <input
                                type="text"
                                id="edit-filename"
                                class="w-full px-4 py-3 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-all text-slate-900 dark:text-slate-100"
                            >
                            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Change the file name (extension will be preserved)</p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Category</label>
                            <select
                                id="edit-category"
                                class="w-full px-4 py-3 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-all text-slate-900 dark:text-slate-100"
                            >
                                <option value="">No category</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Add New Category</label>
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    id="new-category"
                                    placeholder="Enter category name..."
                                    class="flex-1 px-4 py-3 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-all text-slate-900 dark:text-slate-100"
                                >
                                <button
                                    id="add-category-btn"
                                    class="px-4 py-3 bg-violet-600 text-white font-semibold rounded-xl hover:bg-violet-700 transition-all"
                                >
                                    Add
                                </button>
                            </div>
                        </div>

                        <div class="pt-4 space-y-2 text-sm">
                            <div class="flex justify-between text-slate-600 dark:text-slate-400">
                                <span>Size:</span>
                                <span id="modal-size" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between text-slate-600 dark:text-slate-400">
                                <span>Dimensions:</span>
                                <span id="modal-dimensions" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between text-slate-600 dark:text-slate-400">
                                <span>Format:</span>
                                <span id="modal-format" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between text-slate-600 dark:text-slate-400">
                                <span>Modified:</span>
                                <span id="modal-modified" class="font-medium"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-slate-200 dark:border-slate-700">
                <button id="hide-photo-btn" class="px-6 py-3 text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-950 rounded-xl transition-all font-medium flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                    <span id="hide-btn-text">Hide from Library</span>
                </button>
                <div class="flex gap-3">
                    <button id="cancel-edit" class="px-6 py-3 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-all font-medium">
                        Cancel
                    </button>
                    <button id="save-edit" class="px-6 py-3 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-violet-700 hover:to-indigo-700 transition-all shadow-lg shadow-violet-500/30">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentOffset = 0;
        const limit = 60;
        let totalPhotos = 0;
        let viewingDuplicates = false;
        let currentPhoto = null;
        let availableCategories = [];

        // Load stats
        async function loadStats() {
            const res = await fetch('/api/stats');
            const data = await res.json();

            document.getElementById('total-photos').textContent = data.total.toLocaleString();
            document.getElementById('total-size').textContent = data.total_size_gb.toFixed(2) + ' GB';
            document.getElementById('duplicate-groups').textContent = data.duplicate_groups;

            // Update summary in header
            const summary = `${data.total.toLocaleString()} photos • ${data.total_size_gb.toFixed(0)} GB`;
            document.getElementById('stats-summary').textContent = summary;

            const formatsHtml = data.formats.slice(0, 3).map(f =>
                `${f.format}: ${f.count}`
            ).join('<br>');
            document.getElementById('formats').innerHTML = formatsHtml;
        }

        // Load photos
        async function loadPhotos() {
            const search = document.getElementById('search-input').value;
            const category = document.getElementById('category-select').value;
            const sortBy = document.getElementById('sort-select').value;

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('photos-grid').innerHTML = '';

            const res = await fetch(`/api/photos?limit=${limit}&offset=${currentOffset}&search=${search}&category=${category}&sort_by=${sortBy}`);
            const data = await res.json();

            totalPhotos = data.total;
            document.getElementById('loading').classList.add('hidden');

            const grid = document.getElementById('photos-grid');

            // Category emoji map
            const categoryEmojis = {
                'screenshot': '📸',
                'photo': '📷',
                'wallpaper': '🖼️',
                'social': '💬',
                'icon': '🎨',
                'graphic': '✨',
                'image': '🖼️'
            };

            data.photos.forEach(photo => {
                const card = document.createElement('div');
                card.className = 'photo-card bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden cursor-pointer border border-slate-100 dark:border-slate-700';
                card.innerHTML = `
                    <img
                        src="${photo.thumbnail || '/static/placeholder.jpg'}"
                        alt="${photo.path}"
                        class="thumbnail w-full"
                        loading="lazy"
                        draggable="false"
                    >
                    <div class="p-3">
                        <div class="text-xs font-medium text-slate-700 dark:text-slate-300 truncate">${photo.path.split('/').pop()}</div>
                        <div class="text-xs text-slate-400 dark:text-slate-500 mt-1">${photo.size_mb} MB • ${photo.format}</div>
                        ${photo.width ? `<div class="text-xs text-slate-400 dark:text-slate-500">${photo.width} × ${photo.height}</div>` : ''}
                        ${photo.category ? `<div class="inline-block text-xs font-medium text-violet-600 dark:text-violet-400 bg-violet-50 dark:bg-violet-950 px-2 py-1 rounded-md mt-2">${photo.category}</div>` : ''}
                    </div>
                `;

                card.onclick = (e) => {
                    e.preventDefault();
                    if (e.shiftKey || e.metaKey) {
                        openPhoto(photo.id); // Open in Finder if Shift/Cmd key is held
                    } else {
                        openEditModal(photo.id); // Open edit modal
                    }
                };
                grid.appendChild(card);
            });

            // Update pagination
            updatePagination();
        }

        // Load duplicates
        async function loadDuplicates() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('photos-grid').innerHTML = '';

            const res = await fetch('/api/duplicates');
            const data = await res.json();

            document.getElementById('loading').classList.add('hidden');

            const grid = document.getElementById('photos-grid');
            grid.className = 'space-y-6'; // Change layout for duplicates

            data.duplicates.forEach(dup => {
                const group = document.createElement('div');
                group.className = 'bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 border border-slate-100 dark:border-slate-700';
                group.innerHTML = `
                    <div class="mb-4 flex items-center gap-2">
                        <span class="inline-flex items-center gap-2 text-rose-600 dark:text-rose-400 font-bold bg-rose-50 dark:bg-rose-950 px-3 py-2 rounded-xl">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            ${dup.count} duplicates
                        </span>
                        <span class="text-slate-500 dark:text-slate-400 font-medium">${dup.size_mb} MB each</span>
                    </div>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                        ${dup.photos.map(photo => `
                            <div class="cursor-pointer hover:opacity-75 transition-all" onclick="openPhoto(${photo.id})">
                                <img src="${photo.thumbnail}" class="thumbnail w-full rounded-lg border border-slate-100 dark:border-slate-700">
                                <div class="text-xs text-slate-500 dark:text-slate-400 font-medium truncate mt-2">${photo.path.split('/').pop()}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                grid.appendChild(group);
            });

            document.getElementById('pagination').classList.add('hidden');
        }

        // Open photo in Finder
        async function openPhoto(photoId) {
            await fetch(`/api/open/${photoId}`, { method: 'POST' });
        }

        // Load categories
        async function loadCategories() {
            const res = await fetch('/api/categories');
            const data = await res.json();
            availableCategories = data.categories;

            // Update category dropdown
            const categorySelect = document.getElementById('edit-category');
            categorySelect.innerHTML = '<option value="">No category</option>';
            availableCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        // Open edit modal
        async function openEditModal(photoId) {
            const res = await fetch(`/api/photo/${photoId}`);
            currentPhoto = await res.json();

            // Populate modal
            document.getElementById('modal-image').src = currentPhoto.thumbnail || '';
            document.getElementById('edit-filename').value = currentPhoto.path.split('/').pop().split('.').slice(0, -1).join('.');
            document.getElementById('edit-category').value = currentPhoto.category || '';
            document.getElementById('modal-size').textContent = currentPhoto.size_mb + ' MB';
            document.getElementById('modal-dimensions').textContent = `${currentPhoto.width} × ${currentPhoto.height}`;
            document.getElementById('modal-format').textContent = currentPhoto.format;
            document.getElementById('modal-modified').textContent = new Date(currentPhoto.date_modified).toLocaleString();

            // Update hide button text
            const hideBtnText = document.getElementById('hide-btn-text');
            hideBtnText.textContent = currentPhoto.hidden ? 'Show in Library' : 'Hide from Library';

            // Show modal
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        // Close modal
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
            currentPhoto = null;
        }

        // Save photo changes
        async function savePhotoChanges() {
            if (!currentPhoto) return;

            const newFilename = document.getElementById('edit-filename').value;
            const newCategory = document.getElementById('edit-category').value;
            const oldPath = currentPhoto.path;
            const ext = oldPath.split('.').pop();
            const dir = oldPath.substring(0, oldPath.lastIndexOf('/'));
            const newPath = `${dir}/${newFilename}.${ext}`;

            const updates = {
                category: newCategory || null
            };

            if (newPath !== oldPath) {
                updates.file_path = newPath;
            }

            try {
                const res = await fetch(`/api/photo/${currentPhoto.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (res.ok) {
                    closeEditModal();
                    loadPhotos(); // Refresh grid
                    if (newCategory && !availableCategories.includes(newCategory)) {
                        loadCategories(); // Refresh categories if new one was added
                    }
                } else {
                    const error = await res.json();
                    alert('Error: ' + error.detail);
                }
            } catch (err) {
                alert('Failed to update photo: ' + err.message);
            }
        }

        // Toggle hidden status
        async function toggleHidePhoto() {
            if (!currentPhoto) return;

            const newHiddenStatus = !currentPhoto.hidden;

            try {
                const res = await fetch(`/api/photo/${currentPhoto.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hidden: newHiddenStatus })
                });

                if (res.ok) {
                    closeEditModal();
                    loadPhotos(); // Refresh grid to remove hidden photo
                } else {
                    const error = await res.json();
                    alert('Error: ' + error.detail);
                }
            } catch (err) {
                alert('Failed to update photo: ' + err.message);
            }
        }

        // Add new category
        document.getElementById('add-category-btn').addEventListener('click', function() {
            const newCat = document.getElementById('new-category').value.trim();
            if (newCat && !availableCategories.includes(newCat)) {
                const select = document.getElementById('edit-category');
                const option = document.createElement('option');
                option.value = newCat;
                option.textContent = newCat;
                select.appendChild(option);
                select.value = newCat;
                availableCategories.push(newCat);
                document.getElementById('new-category').value = '';
            }
        });

        // Update pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            if (totalPhotos === 0) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');

            const currentPage = Math.floor(currentOffset / limit) + 1;
            const totalPages = Math.ceil(totalPhotos / limit);

            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentOffset === 0;
            nextBtn.disabled = currentOffset + limit >= totalPhotos;
        }

        // Event listeners
        document.getElementById('search-input').addEventListener('input', debounce(() => {
            currentOffset = 0;
            loadPhotos();
        }, 500));

        document.getElementById('category-select').addEventListener('change', () => {
            currentOffset = 0;
            loadPhotos();
        });

        document.getElementById('sort-select').addEventListener('change', () => {
            currentOffset = 0;
            loadPhotos();
        });

        document.getElementById('duplicates-btn').addEventListener('click', () => {
            viewingDuplicates = !viewingDuplicates;
            const btn = document.getElementById('duplicates-btn');

            if (viewingDuplicates) {
                btn.textContent = 'Show All Photos';
                btn.className = 'w-full px-4 py-3 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-violet-700 hover:to-indigo-700 transition-all shadow-lg shadow-violet-500/30';
                loadDuplicates();
            } else {
                btn.textContent = 'Show Duplicates';
                btn.className = 'w-full px-4 py-3 bg-gradient-to-r from-rose-500 to-pink-500 text-white font-semibold rounded-xl hover:from-rose-600 hover:to-pink-600 transition-all shadow-lg shadow-rose-500/30';
                document.getElementById('photos-grid').className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4';
                loadPhotos();
            }
        });

        document.getElementById('prev-btn').addEventListener('click', () => {
            currentOffset = Math.max(0, currentOffset - limit);
            loadPhotos();
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            currentOffset = Math.min(totalPhotos - limit, currentOffset + limit);
            loadPhotos();
        });

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Stats toggle
        const statsToggleBtn = document.getElementById('stats-toggle');
        const statsPanel = document.getElementById('stats-panel');
        const statsChevron = document.getElementById('stats-chevron');

        statsToggleBtn.addEventListener('click', function() {
            statsPanel.classList.toggle('hidden');
            statsChevron.classList.toggle('rotate-180');
        });

        // Theme toggle
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        // Check for saved theme preference or default to dark mode
        const currentTheme = localStorage.getItem('theme') || 'dark';

        if (currentTheme === 'dark') {
            document.documentElement.classList.add('dark');
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            themeToggleDarkIcon.classList.remove('hidden');
        }

        themeToggleBtn.addEventListener('click', function() {
            // Toggle icons
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');

            // Toggle dark mode
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        });

        // Modal event listeners
        document.getElementById('close-modal').addEventListener('click', closeEditModal);
        document.getElementById('cancel-edit').addEventListener('click', closeEditModal);
        document.getElementById('save-edit').addEventListener('click', savePhotoChanges);
        document.getElementById('hide-photo-btn').addEventListener('click', toggleHidePhoto);

        // Close modal on backdrop click
        document.getElementById('edit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Initialize
        loadStats();
        loadPhotos();
        loadCategories();
    </script>
</body>
</html>
